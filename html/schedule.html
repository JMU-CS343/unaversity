<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Schedule | Unaversity</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Shared global styles (navbar, hero, etc.) -->
  <link rel="stylesheet" href="../css/styles.css">
  <script src="../scripts/calender.js"></script>

  <link rel="stylesheet" href="../css/schedule.css">
  <link rel="stylesheet" href="../css/transitions.css">
  <link href="https://fonts.googleapis.com/css2?family=Ultra&display=swap" rel="stylesheet">

  <!-- MAP STUFF (CSS first) -->
  <link rel="stylesheet" href="../css/map.css">

  <!-- Robust loader for map.js + initMap shim -->
  <script>
    (function () {
      // Try ../map.js; if missing, try ../scripts/map.js
      function tryLoad(src, fallback) {
        var s = document.createElement('script');
        s.src = src;
        s.defer = true;
        s.onload = function () {
          window._mapJsFound = true;
        };
        s.onerror = function () {
          if (fallback) tryLoad(fallback);
          else console.error('Failed to load map.js from both locations');
        };
        document.head.appendChild(s);
      }
      tryLoad('../scripts/map.js');

      // Shim so Google callback always finds window.initMap.
      function shimInit() {
        if (window._mapJsFound && typeof window.initMap === 'function' && window.initMap !== shimInit) {
          return window.initMap(); // call the real one
        }
        setTimeout(shimInit, 150);
      }
      if (typeof window.initMap !== 'function') {
        window.initMap = shimInit;
      }
    })();
  </script>
</head>

<body>
  <header>
    <!-- Expands at lg and up; collapses below lg (phones + iPad) -->
    <nav id="main-nav" class="navbar navbar-expand-lg" aria-label="Primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="../index.html">U<span style="color:#FFD966;">NAV</span>ERSITY</a>
        <link rel="icon" href="../assets/favicon.ico">

        <!-- Burger toggler -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainMenu"
          aria-controls="mainMenu" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Collapsible menu -->
        <div class="collapse navbar-collapse" id="mainMenu">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            <li class="nav-item"><a class="nav-link" href="../index.html">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="schedule.html">Schedule</a></li>
            <li class="nav-item"><a class="nav-link" href="#">Stats</a></li>
            <li class="nav-item"><a class="nav-link" href="theme.html">Theme</a></li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <div class="wrapper">
    <button id="add-class" class="btn btn-primary rounded-circle mt-5" data-bs-toggle="modal"
      data-bs-target="#addClassModal">
      +
    </button>
    <!-- Set manual input modal to have class manualInputModal to work with the button-->
    <div class="modal fade" id="addClassModal" tabindex="-1" aria-labelledby="addClassModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addClassModalLabel">Add a Class</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="d-grid gap-3">
              <button id="manual-add-class" class="btn btn-outline-primary btn-lg" data-bs-dismiss="modal"
                data-bs-toggle="modal" data-bs-target="#manualInputModal">
                <i class="bi bi-pencil-square"></i> Enter Class Information Manually
              </button>
              <button class="btn btn-outline-primary btn-lg" data-bs-dismiss="modal"
                onclick="document.getElementById('icsFileInput').click()">
                <i class="bi bi-file-earmark-arrow-up"></i> Import from ICS File
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- Hidden file input for ICS -->
    <input type="file" id="icsFileInput" accept=".ics" style="display: none;" onchange="handleFileSelect(event)">


    <div class="modal fade" id="parseReportModal" tabindex="-1" aria-labelledby="fileImportResult">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Importing your file...</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">

          </div>
        </div>
      </div>
    </div>

    <!-- Weekday buttons (desktop only) -->
    <nav id="week-nav" class="d-none d-lg-block">
      <ul>
        <li><a href="#monday">MONDAY</a></li>
        <li><a href="#tuesday">TUESDAY</a></li>
        <li><a href="#wednesday">WEDNESDAY</a></li>
        <li><a href="#thursday">THURSDAY</a></li>
        <li><a href="#friday">FRIDAY</a></li>
      </ul>
    </nav>

    <!-- Mobile/Tablet "Weekdays" dropdown (shown on tablet + phone) -->
    <div id="weekdays-mobile" class="d-lg-none px-3" style="margin-top: 8rem;">
      <div class="dropdown w-100">
        <button
          class="btn btn-warning w-100 rounded-3 fw-bold dropdown-toggle"
          type="button"
          data-bs-toggle="dropdown"
          data-bs-display="static"
          data-bs-offset="0,0"
          aria-expanded="false"
          title="Keyboard shortcuts: Ctrl+1 Mon, Ctrl+2 Tue, Ctrl+3 Wed, Ctrl+4 Thu, Ctrl+5 Fri">
          Weekdays
        </button>
        <ul class="dropdown-menu w-100">
          <li><a class="dropdown-item" href="#monday">MONDAY</a></li>
          <li><a class="dropdown-item" href="#tuesday">TUESDAY</a></li>
          <li><a class="dropdown-item" href="#wednesday">WEDNESDAY</a></li>
          <li><a class="dropdown-item" href="#thursday">THURSDAY</a></li>
          <li><a class="dropdown-item" href="#friday">FRIDAY</a></li>
        </ul>
      </div>
    </div>


    <main>
      <ul id="class-list">
        <!--Individual Class-->
        <li>
          <form>
            <input type="text" class="class-name" name="class-name" placeholder="Class name">
            <input type="text" class="prof-name" name="prof-name" placeholder="Professor">
            <input type="time" class="time" name="start-time">
            <input type="time" class="time" name="end-time">
            <input type="text" class="location" name="location" placeholder="Location">
            <button class="delete-class" type="button">-</button>
          </form>
        </li>
      </ul>
      <button id="clear-classes" type="button">Clear All</button>
    </main>

    <aside id="map-background">
      <div id="map"></div>
      <div id="map-totals">
        <div id="route-time">Total Time Placeholder</div>
        <div id="route-dist">Total Dist Placeholder</div>
      </div>
      <button id="debug-button">DEBUG: King to E-HALL</button>
    </aside>
  </div>

  <script>
    // Apply saved theme (Include in every page)
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);
  </script>

  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB1a1vLs-1g38ba2gVD2yrJfGHBm8sxet4&callback=initMap"
    async defer></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    //set current date
    days = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];

    window.location.hash = days[new Date().getDay()]
  </script>

  <!-- Hide mobile "Weekdays" when navbar menu is open -->

  <script>
      (function () {
        const menu = document.getElementById('mainMenu');
        const weekdays = document.getElementById('weekdays-mobile');

        if (!menu || !weekdays) return;

        function syncWeekdays() {
          if (menu.classList.contains('show')) {
            weekdays.classList.add('d-none');
          } else {
            weekdays.classList.remove('d-none');
          }
        }

        menu.addEventListener('shown.bs.collapse', syncWeekdays);
        menu.addEventListener('hidden.bs.collapse', syncWeekdays);
        syncWeekdays();
      })();
  </script>

  <!--Add/Delete/Clear classes-->
  <script>
    // Add new class
    document.getElementById("manual-add-class").addEventListener("click", function () {
      const classList = document.getElementById("class-list");
      const newClass = document.createElement("li");

      // Remove placeholder text before adding class
      const classPlaceholderText = document.getElementById("class-placeholder-text");
      if (classPlaceholderText) {
        classPlaceholderText.remove();
      }
      // Remove mode/duration/arrow from first class in list
      const isFirst = classList.children.length === 0;

      newClass.innerHTML = `
        ${isFirst ? '' : `
        <div class="mode-duration-wrapper">
          <select class="form-select mode-duration" aria-label="Select mode">
            <option class="mode-option" value="1">Walk</option>
            <option class="mode-option" value="2">Bike</option>
            <option class="mode-option" value="3">Drive</option>
          </select>
          <img src="../assets/Arrow.png">
          <div class="mode-duration">0 min</div>
        </div>
        `}
        <form>
          <input type="text" class="class-name" name="class-name" placeholder="Class name">
          <input type="text" class="prof-name" name="prof-name" placeholder="Professor">
          <input type="time" class="time" name="start-time">
          <input type="time" class="time" name="end-time">
          <input type="text" class="location" name="location" placeholder="Location">
          <button class="delete-class" type="button">-</button>
        </form>
      `;
      classList.appendChild(newClass);
    });

    // Delete class
    document.getElementById("class-list").addEventListener("click", function (e) {
      if (e.target && e.target.classList.contains("delete-class")) {
        e.preventDefault();
        const classToDelete = e.target.closest("li");
        classToDelete.remove();
      }
    });

    // Clear classes
    document.getElementById("clear-classes").addEventListener("click", function () {
      const classList = document.getElementById("class-list");
      classList.innerHTML = "";
    });
  </script>
  <script>
  (function () {
    const mapNumToDay = { 1: "monday", 2: "tuesday", 3: "wednesday", 4: "thursday", 5: "friday" };

    function isTypingTarget(el) {
      return el &&
             (el.tagName === "INPUT" || el.tagName === "TEXTAREA" || el.isContentEditable);
    }

    // Apply ?day= on initial load (keeps hash + display in sync if the link is shared)
    window.addEventListener("DOMContentLoaded", () => {
      const params = new URL(window.location).searchParams;
      const qDay = params.get("day");
      if (qDay) window.location.hash = qDay;
    });

    // Ctrl+1..5 to jump to Mon..Fri
    window.addEventListener("keydown", (e) => {
      if (!e.ctrlKey || e.shiftKey || e.altKey || e.metaKey) return;

      const n = Number(e.key);
      if (!(n >= 1 && n <= 5)) return;
      if (isTypingTarget(document.activeElement)) return;

      e.preventDefault();

      const day = mapNumToDay[n];

      // Update hash for your existing hashchange/displayClasses flow
      window.location.hash = day;

      // Mirror into ?day= for shareable links, without reloading
      const url = new URL(window.location);
      url.searchParams.set("day", day);
      history.replaceState(null, "", url);

      // Close the Weekdays dropdown if it's open
      const openMenu = document.querySelector("#weekdays-mobile .dropdown-menu.show");
      if (openMenu) {
        const toggle = document.querySelector("#weekdays-mobile [data-bs-toggle='dropdown']");
        if (toggle) toggle.click();
      }

      // Refresh classes immediately (in case no hashchange fires)
      if (typeof displayClasses === "function") {
        displayClasses();
        const list = document.getElementById("class-list");
        if (list) list.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    });
  })();
</script>
</body>

</html>
